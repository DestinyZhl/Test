
<!-- Main content -->
<section class="content portal-content">

    <!--次標題 與 搜尋-->
    <div class="row">
        <!--次標題與Search keyword-->
        <div class="col-md-12 col-lg-9">
            <h4 class="margin-td-5" id="js_search_keywords"></h4>
        </div><!-- /col-次標題與Search keyword -->
        <!--col-右方搜尋與功能按鈕列-->
        <div class="col-md-12 search-field col-lg-3">
            <a class="btn btn-default btn-sm" data-toggle="modal" data-target="#js_search_modal"><i class="fa fa-search"></i> 搜索</a>

        </div><!-- /col-右方搜尋與功能按鈕列-->
    </div><!--/次標題 與 搜尋-->
    <hr class="hr-custom">

    <!--row Search Keyword collapse-->
    <div class="row">
        <div class="col-xs-12" id="js_criteria_alert_cnt">
        </div>
    </div> <!--/row Search Keyword collapse-->
    <!--內容 上传Div-->
    <div class="row">
        <div class="col-xs-12">
            <h4>制程导入</h4>
@using (Html.BeginForm("ImportExcel", "FlowChart", FormMethod.Post, new { id = "js_form_excel_add" })) {
            <div class="row">
                <div class="col-sm-1">
                    <label class="control-label" for="js_s_input_upload">选择文件</label>
                </div>
                <div class="col-sm-5">
                    <input type="file" class="form-control" id="js_s_input_upload" name="uploadName"  placeholder="请选择EXCEL文件上传"/>
                </div>
            </div>

            <div class="row">
                <label class="col-sm-1 control-label" for="js_s_input_version_comment">版本说明</label>
                <div class="col-sm-5">
                    <textarea type="text" name="FlowChart_Version_Comment" class="form-control input-sm" id="js_s_input_version_comment"placeholder="版本说明"></textarea>
                </div>
                <div class="col-sm-6">
                    <div class=" pull-right">
                        <button type="button" class="fa fa-upload btn btn-primary" id="js_btn_import_fl">上传</button>
                        <button type="button" class="fa fa-download btn btn-primary" id="js_btn_download_fl">模板下载</button>
                    </div>
                </div>
            </div>
            }
        </div>
    </div>
    <!--內容 表格列-->
    <div class="row">
        <!--表格-->
@using (Html.BeginForm("DataTableExec", "FlowChart", FormMethod.Post, new { id = "js_form_datatable_exec" })) {
        <div class="col-md-12 table-container">
            <table class="table table-striped table-hover table-condensed nowrap" id="js_user_datatable">
                <thead>
                    <tr>
                        @*<th class="table-col-checkbox nosort">
                            <input type="checkbox" class="js-checkbox-all" />
                        </th>*@
                        <th class="table-col-action nosort">操作</th>
                        <th class="table-col-seq nosort">序号</th>
                        <th>客户</th>
                        <th>专案</th>
                        <th>部件</th>
                        <th>生产阶段</th>
                        <th>状态</th>
                        <th>版本</th>
                        <th>版本说明</th>
                        <th>创建者</th>
                        <th>创建时间</th>
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                        @*<th class="table-col-checkbox nosort"></th>*@
                        <th class="table-col-action nosort">操作</th>
                        <th class="table-col-seq nosort">序号</th>
                        <th>客户</th>
                        <th>专案</th>
                        <th>部件</th>
                        <th>生产阶段</th>
                        <th>状态</th>
                        <th>版本</th>
                        <th>版本说明</th>
                        <th>创建者</th>
                        <th>创建时间</th>
                    </tr>
                </tfoot>
            </table>
            <div id="page" class="row"></div>

        </div><!--/表格-->
    }
    </div><!-- / 內容 表格列 -->


</section><!-- /.content -->

@section ViewModals{
    <!-- Modal -->
    <div class="modal fade" id="js_search_modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">搜索</h4>
                </div>
                <div class="modal-body form-horizontal">
                    <div class="row">
                        <form id="js_form_query" data-need-validate="true">

                            <div class="form-group col-xs-12 col-md-6">
                                <label class="col-sm-5 control-label" for="js_s_input_bu_id">客户</label>
                                <div class="col-sm-7">
                                    <input type="text" name="BU_D_Name" class="form-control input-sm" id="js_s_input_bu_id" placeholder="客户">
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6">
                                <label class="col-sm-5 control-label" for="js_s_input_bu_name">专案</label>
                                <div class="col-sm-7">
                                    <input type="text" name="Project_Name" class="form-control input-sm" id="js_s_input_bu_name" placeholder="专案">
                                </div>
                            </div>


                            <div class="form-group col-xs-12 col-md-6">
                                <label class="col-sm-5 control-label" for="js_s_input_ref_date">部件</label>
                                <div class="col-sm-7">
                                    <input type="text" name="Part_Types" class="form-control input-sm" id="js_s_input_bu_name" placeholder="部件">
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6">
                                <label class="col-sm-5 control-label" for="js_s_input_ref_date">生产阶段</label>
                                <div class="col-sm-7">
                                    <input type="text" name="Product_Phase" class="form-control input-sm" id="js_s_input_bu_name" placeholder="生产阶段">
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6">
                                <label class="col-sm-5 control-label" for="js_s_input_ref_date">状态</label>
                                <div class="col-sm-7">
                                    <select id="js_s_input_status" name="Is_Closed" class="form-control input-sm">
                                        @foreach (KeyValuePair<int, string> statusItem in ViewBag.Status)
                                        {
                                            if (@statusItem.Key == 2)
                                            {
                                                <option value=@statusItem.Key selected="selected">@statusItem.Value</option>
                                            }
                                            else
                                            {
                                                <option value=@statusItem.Key>@statusItem.Value</option>
                                            }

                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6">
                                <label class="col-sm-5 control-label" for="js_s_input_ref_date">最新版</label>
                                <div class="col-sm-7">
                                    <select id="js_s_input_lastest" name="Is_Latest" class="form-control input-sm">
                                        @foreach (KeyValuePair<int, string> statusItem in ViewBag.Lastest)
                                    {
                                        if (@statusItem.Key == 1)
                                        {
                                            <option value=@statusItem.Key selected="selected">@statusItem.Value</option>
                                        }
                                        else
                                        {
                                            <option value=@statusItem.Key>@statusItem.Value</option>
                                        }
                                    }
                                    </select>
                                </div>
                            </div>

                            <div class="form-group col-xs-12 col-md-6">
                                <label class="col-sm-5 control-label" for="js_s_input_modified_from">最后修改时间 起</label>
                                <div class="col-sm-7">
                                    <div class="input-group">
                                        <div class="input-group-addon">
                                            <i class="fa fa-calendar"></i>
                                        </div>
                                        <input type="text" name="Modified_Date_From" class="form-control input-sm date" id="js_s_input_modified_from" placeholder="最后修改时间 起">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6">
                                <label class="col-sm-5 control-label" for="js_s_input_modified_to">最后修改时间 止</label>
                                <div class="col-sm-7">
                                    <div class="input-group">
                                        <div class="input-group-addon">
                                            <i class="fa fa-calendar"></i>
                                        </div>
                                        <input type="text" name="Modified_Date_End" class="form-control input-sm date" id="js_s_input_modified_to" placeholder="最后修改时间 止">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group col-xs-12 col-md-6">
                                <label class="col-sm-5 control-label" for="js_s_input_modified_by_ntid">修改者</label>
                                <div class="col-sm-7">
                                    <input type="text" name="Modified_By" class="form-control input-sm" id="js_s_input_modified_by_ntid" placeholder="修改者(NTID)">
                                </div>
                            </div>

                        </form>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-default btn-clear" id="js_btn_clear">清空</button>
                    <button id="btn_search" type="button" class="btn btn-primary btn-query">搜索</button>
                </div>
            </div>
        </div>
    </div>

    <!--更新Excel Start-->
    <div class="modal fade" id="js_editExcel_modal" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">更新文件</h4>
                </div>
                @using (Html.BeginForm("ImportExcelUpdate", "FlowChart", FormMethod.Post, new { id = "js_form_excel_update" })) {
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-sm-2">
                                <label class="control-label" for="js_s_input_upload_update">选择文件</label>
                            </div>
                            <div class="col-sm-8">
                                <input type="file" class="form-control" id="js_s_input_upload_update" name="uploadName_update" placeholder="选择文件"
                                       required data-msg-required="请选择要上传的Excel档!" />
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-sm-2">
                                <label class="control-label" for="js_s_input_version_comment_update">版本说明</label>
                            </div>

                            <div class="col-sm-8">
                                <textarea type="text" name="FlowChart_Version_Comment" class="form-control input-sm" id="js_s_input_version_comment_update"
                                          required data-msg-required="请输入版本说明!" placeholder="版本说明"></textarea>
                            </div>
                        </div>

                    </div>

                    <div class="modal-footer">
                        <button type="button" class="fa fa-upload btn btn-primary" id="js_btn_clear_Update">取消</button>
                        <button type="button" class="fa fa-download btn btn-primary" id="js_btn_excel_update">提交</button>
                        <input type="hidden" id="hid_key" name="FlowChart_Master_UID" />
                    </div>
                }
            </div>
        </div>
    </div>
    <!--更新Excel End-->

    <!--历史版本列表 Start-->
    <div class="modal fade" id="js_history_modal" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">历史版本列表</h4>
                </div>
            @using (Html.BeginForm("DoHistoryExcelExport", "FlowChart", FormMethod.Post, new { id = "js_form_history_excelexport" })) {
                <!--內容 表格列-->
                <div class="row">
                    <!--表格-->
                    <div class="col-md-12 table-container">
                        <table class="table table-condensed" id="js_history_datatable">
                            <thead>
                                <tr>
                                    <th class="table-col-action nosort">操作</th>
                                    <th class="table-col-seq nosort">序号</th>
                                    <th class="nosort">版本号</th>
                                    <th class="nosort">版本说明</th>
                                    <th class="nosort">最后修改者</th>
                                    <th class="nosort">修改日期</th>
                                </tr>
                            </thead>
                        </table>
                        @*<div id="page" class="row"></div>*@

                    </div><!--/表格-->
                </div><!-- / 內容 表格列 -->

                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="js_btn_back">返回</button>
                    <input type="hidden" id="history_key" name="FlowChart_Master_UID" />
                </div>
                }
            </div>
        </div>
    </div>
    <!--历史版本列表 End-->
}

@section ViewScripts{
    <script type="text/javascript">
        $(function () {
            var FLMaintenance = (function () {
                var urls = {
                    queryFLS: '@Url.Action("QueryFlowCharts", "FlowChart")',
                    downloadExcel: '@Url.Action("DownloadExcel", "FlowChart")',
                    queryFL: '@Url.Action("QueryFlowChart", "FlowChart")',
                    queryHistoryFL: '@Url.Action("QueryHistoryFlowChart", "FlowChart")',
                    checkFLExcelExist: '@Url.Action("CheckFLExcelExist", "FlowChart")',
                    closeFL: '@Url.Action("ClosedFlowChart", "FlowChart")',
                    deleteFLTemp: '@Url.Action("DeleteFlowChartTemp", "FlowChart")'
                };

                var subDatatable = null;

                var columns = [
                //    {
                //    createdCell: function (td, cellData, rowData, row, col) {
                //        $(td).html('<input type="checkbox" name="cktrans" class="js-checkbox-item" value="' + rowData.FlowChart_Master_UID + '">')
                //             .addClass('table-col-checkbox');
                //    },
                //    className: "text-center"
                //}, 
                {
                    createdCell: function (td, cellData, rowData, row, col) {

                        //导入更新
                        var htmlImportUpdate = '<button type="button" class="btn btn-default btn-sm js-grid-import" data-id="' + rowData.FlowChart_Master_UID + '">导入更新</button></br>';

                        //查看历史版本
                        var htmlhistory = '<button type="button" class="btn btn-default btn-sm js-grid-history" data-id="' + rowData.FlowChart_Master_UID + '">查看历史版本</button> </br>';
                        //关闭
                        var htmlClosed = '<button type="button" class="btn btn-default btn-sm js-grid-closed" data-id="' + rowData.FlowChart_Master_UID + '">关闭</button></br>';
                        //打开
                        var htmlOpen = '<button type="button" class="btn btn-default btn-sm js-grid-open" data-id="' + rowData.FlowChart_Master_UID + '">打开</button></br>';
                        //删除
                        var htmlDelete = '<button type="button" class="btn btn-default btn-sm js-grid-delete" data-id="' + rowData.FlowChart_Master_UID + '">删除</button></br>';

                        //导出
                        var htmlExport = '<button type="button" class="btn btn-default btn-sm js-grid-export" data-isTemp="' + rowData.IsTemp + '" data-id="' + rowData.FlowChart_Master_UID + '">导出</button></br>';

                        //维护  
                        var htmlEditProjectData = '<a href="FlowChartPlanManager?MasterUID=' + rowData.FlowChart_Master_UID + '"><button type="button" class="btn btn-default btn-sm js-grid-editProjectData" data-id="' + rowData.FlowChart_Master_UID + '">维护生产计划</button></a></br>';

                        var result = '<button type="button" class="btn btn-default btn-xs" rel="action-popover">' +
                                     '<i class="fa fa-reorder text-info"></i>' +
                                     '</button>' +
                                     '<div class="hidden popover-content">' +
                                        '<a href="FlowChartDetail/' + rowData.FlowChart_Master_UID + '?IsTemp=' + rowData.IsTemp + '&Version=' + rowData.FlowChart_Version + '"><button type="button" class="btn btn-default btn-sm js-grid-info" data-id="' + rowData.FlowChart_Master_UID + '">制程详情</button></a></br>';

                        if (!rowData.IsTemp) {
                            if (rowData.Is_Closed != 1) {
                                result = result +htmlEditProjectData+ htmlhistory + htmlImportUpdate + htmlClosed + htmlExport;
                            }
                            else {
                                result = result + htmlhistory +  htmlOpen + htmlExport;
                            }
                        }
                        else {
                            result = result + htmlDelete;
                        }

                        result = result + '</div>';
                        $(td).html(result);
                    },
                    className: "text-center"
                }, {
                    data: null,
                    className: "table-col-seq"
                }, {
                    data: "BU_D_Name",
                    className: "min-col-xs"
                }, {
                    data: "Project_Name",
                    className: "min-col-xs"
                }, {
                    data: "Part_Types",
                    className: "min-col-xs"
                }, {
                    data: "Product_Phase",
                    className: "min-col-xs"
                }, {
                    data: "Is_Closed",
                    className: "min-col-xs",
                    createdCell: function (td, cellData, rowData, row, col) {
                        if (rowData.IsTemp) {
                            $(td).html('未生效');
                        }
                        else {
                            if (rowData.Is_Closed == 1) {
                                $(td).html('关闭');
                            }
                            else {
                                $(td).html('进行中');
                            }
                        }
                    }

                },{
                    data: "FlowChart_Version",
                    className: "min-col-xs"
                },{
                    data: "FlowChart_Version_Comment",
                    className: "min-col-xs"
                }, {
                    data: "User_Name",
                    className: "min-col-xs"
                }, {
                    data: "Modified_Date",
                    className: "min-col-xs"
                }
                ];

                //#region 定义子列
                var subColumns = [{
                    defaultContent: ' ',
                    createdCell: function (td, cellData, rowData, row, col) {
                    var result = '<button class="btn btn-default btn-xs" type="button" rel="action-popover">' +
                     '<i class="fa fa-reorder text-info"></i>' +
                     '</button>' +
                     '<div class="hidden popover-content">' +
                        '<a href="FlowChartDetail/' + rowData.FlowChart_Master_UID + '?IsTemp=' + false + '&Version=' + rowData.FlowChart_Version + '"><button type="button" class="btn btn-default btn-sm js-grid-info" data-id="' + rowData.FlowChart_Master_UID + '">查看</button></a>' +
                        '<button type="button" class="btn btn-default btn-sm js-history-export" data-id="' + rowData.FlowChart_Master_UID + '">导出</button>' +
                     '</div>';

                    $(td).html(result);
                    },
                    className: "text-center"
                },
                    {
                    className: "table-col-seq",
                    render: function (data, type, full, meta) {
                        return ++meta.row;
                    }
                }, {
                    data: "FlowChart_Version",
                    className: "min-col-lg",

                },{
                    data: "FlowChart_Version_Comment",
                    className: "min-col-lg",

                },{
                    data: "User_Name",
                    className: "min-col-lg",
                }, {
                    data: "Modified_Date",
                    className: "min-col-lg",
                }];
                //#endregion

                var _getParams = function () {
                    return $('#js_form_query').serialize().replace(/\+/g, " ");
                };

                var _queryFLS = function (firstLoad) {

                    var config = {
                        pageId: "#page",
                        tableId: "#js_user_datatable",
                        remoteUrl: urls.queryFLS,
                        searchParams: _getParams(),
                        tableOptions: {
                            scrollX: true,
                            autoWidth: true,
                            columns: columns
                        }

                    };

                    if (!firstLoad) {
                        $('#page').page('destroy');
                        SPP.Utility.Criteria.Build();
                    }

                    SPP.Utility.Pages.Set(config);
                    
                };

                return {
                    urls: urls,
                    Init: function () {
                        SPP.Utility.Criteria.Init();
                        _queryFLS(true);

                    },
                    QueryFLCharts: function () {
                        _queryFLS(false);
                    },
                    SetSubDatatable: function (datatable) {
                        subDatatable = datatable;
                    },
                    SubColumns: subColumns
                }
            })();

            FLMaintenance.Init();


            //------------------------ 画面一览事件-------------Start

            //#region 模板下载
            $('#js_btn_download_fl').on('click', function () {
                this.form.action = FLMaintenance.urls.downloadExcel;
                $('#js_form_excel_add').submit();
            });
            //#endregion

            //#region Excel导入所有事件
            $('#js_btn_import_fl').on('click', function () {
                $.blockUI({ message: "<h1>导入中，请稍后...</h1>" });
                $('#js_form_excel_add').ajaxSubmit({
                    beforeSubmit: function () {
                        var input1 = $('#js_s_input_upload').val();
                        var input2 = $('#js_s_input_version_comment').val();
                        
                        if (input1 == '') {
                            //SPP.Utility.MessageBox.info('今年没有涨工资，坑爹!');
                            SPP.Utility.MessageBox.info('请选择要上传的Excel档!');
                            $.unblockUI();
                        }
                        if (input2 == '') {
                            //SPP.Utility.MessageBox.info('来了一年半没涨，我也是真心醉了!');
                            SPP.Utility.MessageBox.info('请输入版本说明!');
                            $.unblockUI();
                        }
                        if (input1 == '' || input2 == '') {
                            $.unblockUI();
                            return false;
                        }
                    },
                    success: function (data) {
                        $.unblockUI();
                        if (data != '') {
                            SPP.Utility.MessageBox.info(data);
                        }
                        else {
                            SPP.Utility.MessageBox.info('导入成功');
                            window.location.reload();
                        }
                    }
                });
            });
            //#endregion

            //------------------------ 画面一览事件-------------End



            //#region 画面一览DataTable所有事件

            //#region DataTable导出Excel事件
            $('body').on('click', '.js-grid-export', function () {
                $.blockUI({ message: "<h1>正在导出，请稍后...</h1>" });
                setTimeout($.unblockUI, 6000);
                var FlowChart_Master_UID = $(this).attr('data-id');
                var isTemp = $(this).attr('data-isTemp');
                $('#js_form_datatable_exec').attr('action', '../FlowChart/DoHistoryExcelExport?id=' + FlowChart_Master_UID + '&isTemp='+isTemp);
                $('#js_form_datatable_exec').submit();
                
            });
            //#endregion

            //#region DataTable的关闭专案事件
            $('body').on('click', '.js-grid-closed', function () {
                var FlowChart_Master_UID = $(this).attr('data-id');
                SPP.Utility.MessageBox.confirm("确定要关闭这个专案吗?", function () {
                    $.blockUI({ message: "<h1>请稍后...</h1>" });
                    var url = FLMaintenance.urls.closeFL;
                    $.post(url, { FlowChart_Master_UID: FlowChart_Master_UID, IsClosed: true }, function (data) {
                        $.unblockUI();
                        if (data) {
                            FLMaintenance.QueryFLCharts();
                        }
                        else {
                            SPP.Utility.MessageBox.error("关闭专案出错，请联系管理员!");
                        }
                    });
                });
            });
            //#endregion DataTable的关闭专案事件

            //#region DataTable的打开专案事件
            $('body').on('click', '.js-grid-open', function () {
                var FlowChart_Master_UID = $(this).attr('data-id');
                SPP.Utility.MessageBox.confirm("确定要打开这个专案吗?", function () {
                    $.blockUI({ message: "<h1>请稍后...</h1>" });
                    var url = FLMaintenance.urls.closeFL;
                    $.post(url, { FlowChart_Master_UID: FlowChart_Master_UID, IsClosed: false }, function (data) {
                        $.unblockUI();
                        if (data) {
                            FLMaintenance.QueryFLCharts();
                        }
                        else {
                            SPP.Utility.MessageBox.error("打开专案出错，请联系管理员!");
                        }
                    });
                });
            });
            //#endregion DataTable的打开专案事件

            //#region DataTable的删除未生效专案事件
            $('body').on('click', '.js-grid-delete', function () {
                var FlowChart_Master_UID = $(this).attr('data-id');
                SPP.Utility.MessageBox.confirm("确定要删除这个专案吗?", function () {
                    $.blockUI({ message: "<h1>请稍后...</h1>" });
                    var url = FLMaintenance.urls.deleteFLTemp;
                    $.post(url, { FlowChart_Master_UID: FlowChart_Master_UID }, function (data) {
                        $.unblockUI();
                        FLMaintenance.QueryFLCharts();
                    });
                });
            });
            //#endregion DataTable的删除未生效专案事件

            //#endregion



            //------------------div弹出Excel导入更新-------------Start
            //#region Excel编辑所有事件

            //#region 点击excel导入更新弹出div事件
            $('body').on('click', '.js-grid-import', function () {
                var FlowChart_Master_UID = $(this).attr('data-id');
                $('#hid_key').val(FlowChart_Master_UID);
                $.get(FLMaintenance.urls.queryFL, { FlowChart_Master_UID: FlowChart_Master_UID }, function (data) {
                    var customer = data.BU_D_Name;
                    var projectName = data.SystemProjectDTO.Project_Name;
                    var partTypes = data.FlowChartMasterDTO.Part_Types;
                    var phase = data.SystemProjectDTO.Product_Phase;
                    $('#js_editExcel_modal').find('.modal-title').text("更新" + customer + " " + projectName + " " + partTypes + " " + phase);
                });
                $('#js_editExcel_modal').modal('show');
            });
            //#endregion

            //#region 取消按钮事件
            $('#js_btn_clear_Update').click(function () {
                $('#js_s_input_upload_update').val('');
                $('#js_s_input_version_comment_update').val('');
                //$('#hid_key').val('');
            });
            //#endregion

            //#region 更新Excel提交按钮
            $('#js_btn_excel_update').on('click', function () {
                $.blockUI({ message: "<h1>导入中，请稍后...</h1>" });
                $('#js_form_excel_update').ajaxSubmit({
                    beforeSubmit: function () {
                        if (!$('#js_form_excel_update').valid()) {
                            $.unblockUI();
                            return false;
                        }
                    },
                    success: function (data) {
                        $.unblockUI();
                        if (data != '') {
                            SPP.Utility.MessageBox.info(data);
                        }
                        else {
                            $('#js_editExcel_modal').modal('hide');
                            SPP.Utility.MessageBox.info('更新成功');
                            window.location.reload();
                        }
                    }
                });
            });
            //#endregion

            //#region 隐藏modal框时清空值
            $('#js_editExcel_modal').on('hidden.bs.modal', function (e) {
                $('#js_editExcel_modal').find('input').val('');
                $('#js_editExcel_modal').find('textarea').val('');
                $('.list-group.validate-error').empty();
            });
            //#endregion 隐藏modal框时清空值

            //#endregion
            //------------------div弹出Excel导入更新-------------End

            //------------------div弹出查看历史版本-------------Start
            //#region 查看历史版本所有事件

            //#region 查看历史版本加载数据
            $('body').on('click', '.js-grid-history', function () {
                var FlowChart_Master_UID = $(this).attr('data-id');
                $('#history_key').val(FlowChart_Master_UID);
                $.get(FLMaintenance.urls.queryHistoryFL, { FlowChart_Master_UID: FlowChart_Master_UID }, function (data) {
                    if (data != '') {
                        var item = data[0];
                        var customer = item.BU_D_Name;
                        var projectName = item.Project_Name;
                        var partTypes = item.Part_Types;
                        var phase = item.Product_Phase;

                        //绑定子表
                        var subTable = $('#js_history_datatable').DataTable({
                            //scrollX: true,
                            //autoWidth: true,
                            columns: FLMaintenance.SubColumns,
                            ordering: false,
                            data: data,
                            destroy: true
                        });

                        FLMaintenance.SetSubDatatable(subTable);

                        $('#js_history_modal').find('.modal-title').text(customer + " " + projectName + " " + partTypes + " " + phase + " 历史版本列表");
                    }
                });
                $('#js_history_modal').modal('show');
            });
            //#endregion 查看历史版本加载数据

            //#region 导出Excel
            $('body').on('click', '.js-history-export', function () {
                var FlowChart_Master_UID = $(this).attr('data-id');

                $('#js_form_history_excelexport').attr('action', '../FlowChart/DoHistoryExcelExport?id=' + FlowChart_Master_UID + '&isTemp=true');
                $('#js_form_history_excelexport').submit();

            });
            //#endregion

            //#region 返回事件
            $('#js_btn_back').on('click', function () {
                $('#history_key').val('');
                $('#js_history_modal').modal('hide');
            });
            //#endregion

            //#endregion
            //------------------div弹出查看历史版本-------------End

            //------------------div弹出搜索框-------------Start
            //#region 搜索弹出框事件
            $('#js_search_modal').on('show.bs.modal', function (event) {
                //$('#js_s_input_ref_date').val(moment().format("YYYY-MM-DD"));
            });

            $('#js_btn_clear').click(function () {

                //如果没有特殊项的Clear，直接调用Clear方法
                //SPP.Utility.Criteria.Clear();
                SPP.Utility.Criteria.Clear(function () {
                    $('#js_s_input_status').find("option[value=0]").attr("selected", true);
                    $('#js_s_input_lastest').find("option[value=1]").attr("selected", true);
                });
            });

            $('#btn_search').click(function () {
                FLMaintenance.QueryFLCharts();
                $('#js_search_modal').modal('hide');
            });
            //#endregion
            //------------------div弹出搜索框-------------End

        });
    </script>
}
